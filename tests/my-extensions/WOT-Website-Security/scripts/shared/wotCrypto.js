function strtobin(t){const e=[];for(let n=0;n<t.length;++n)e[n]=255&t.charCodeAt(n);return e}function bintostr(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(255&t[n]);return e}function hextobin(t){const e=function(t){const e="a".charCodeAt(0);return t>=e?t-e+10:t-"0".charCodeAt(0)},n=[];for(let r=0;r<t.length/2;++r)n[r]=e(t.charCodeAt(2*r))<<4|15&e(t.charCodeAt(2*r+1));return n}function bintohex(t){const e="0123456789abcdef";let n="";for(let r=0;r<t.length;++r)n+=e.charAt(t[r]>>4&15),n+=e.charAt(15&t[r]);return n}const sha1={hmacsha1hex(t,e){let n=hextobin(t);n.length>20&&(n=this.sha1bin(n));const r=Array(64),o=Array(64);for(let t=0;t<20;++t)r[t]=54^n[t],o[t]=92^n[t];for(let t=20;t<64;++t)r[t]=54,o[t]=92;const s=this.sha1bin(r.concat(strtobin(e)));return this.sha1bin(o.concat(s))},sha1bin(t){return this.sha1str(bintostr(t))},sha1hex(t){return this.sha1str(hextostr(t))},sha1str(t){const e=function(t,e,n,r){return t<20?e&n|~e&r:t>=40&&t<60?e&n|e&r|n&r:e^n^r},n=function(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514},r=function(t,e){const n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n},o=function(t,e){return t<<e|t>>>32-e},s=8*t.length;let c=[];for(var h=0;h<s;h+=8)c[h>>5]|=(255&t.charCodeAt(h/8))<<24-h%32;c[s>>5]|=128<<24-s%32,c[15+(s+64>>9<<4)]=s;const i=Array(80);let a=1732584193,l=-271733879,u=-1732584194,f=271733878,d=-1009589776;for(h=0;h<c.length;h+=16){const t=a,s=l,y=u,b=f,g=d;for(let t=0;t<80;t++){i[t]=t<16?c[h+t]:o(i[t-3]^i[t-8]^i[t-14]^i[t-16],1);const s=r(r(o(a,5),e(t,l,u,f)),r(r(d,i[t]),n(t)));d=f,f=u,u=o(l,30),l=a,a=s}a=r(a,t),l=r(l,s),u=r(u,y),f=r(f,b),d=r(d,g)}c=[a,l,u,f,d],t="";for(h=0;h<32*c.length;h+=8)t+=String.fromCharCode(c[h>>5]>>>24-h%32&255);return strtobin(t)}},arc4={create(t){let e,n,r=0,o=0;const s={s:[],x:1,y:0};for(e=0;e<256;++e)s.s[e]=e;for(e=0;e<256;++e)n=s.s[e],r=r+t[o]+n&255,s.s[e]=s.s[r],s.s[r]=n,++o>=t.length&&(o=0);return s},crypt(t,e){let n,r,o;const s=[];for(n=0;n<e.length;++n)r=t.s[t.x],t.y=t.y+r&255,o=t.s[t.y],t.s[t.x]=o,t.s[t.y]=r,t.x=t.x+1&255,s[n]=255&(e[n]^t.s[r+o&255]);return s}},base32={set:"abcdefghijklmnopqrstuvwxyz234567",encode(t){try{t=unescape(encodeURIComponent(decodeURIComponent(t)));let e="",n=0,r=0;for(let o=0;o<t.length;++o){const s=t.charCodeAt(o);if(s>255)return null;n=(n<<8)+s,r+=8;do{r-=5,e+=this.set[n>>r&31]}while(r>=5)}return r>0&&(e+=this.set[n<<5-r&31]),e}catch(t){console.log(`base32.encode: failed with ${t}\n`)}return null},decode(t){try{if(!this.rev){this.rev={};for(var e=0;e<this.set.length;++e)this.rev[this.set.charAt(e)]=e}let n="",r=0,o=0;for(e=0;e<t.length;++e){const s=this.rev[t.charAt(e)];if(null==s)return null;for(r=(r<<5)+s,o+=5;o>=8;)o-=8,n+=String.fromCharCode(r>>o&255)}return o>=5?null:decodeURIComponent(escape(n))}catch(t){console.log(`base32.decode: failed with ${t}\n`)}return null}};class WotCryptoClass{constructor(t){this.counter=t||0,this.sha1=sha1,this.arc4=arc4,this.bintohex=bintohex,this.base32=base32}getnonce(t,e){const n=`nonce:${VERSION}:${this.counter++}:${Date.now()}:${Math.random()}:${(e||{id:"",key:""}).id||""}:${t||""}`;return bintohex(this.sha1.sha1str(n))}decrypt(t,e,n){try{if(t&&e){const r=n&&n.witness_key?n.witness_key:this.witness.key;let o=(n||{}).index;const s=(n||{}).response_str;o=null==o||o<0?"":"-"+o;let c=e+o;if(s&&(c="response-"+c),r)return bintostr(this.arc4.crypt(this.arc4.create(this.sha1.hmacsha1hex(r,c)),strtobin(atob(t))))}}catch(t){console.log(`crypto.decrypt: failed with ${t}\n`)}return null}encrypt(t,e,n,r){try{if(t&&e){if(!n)n=(r||{}).key;if(n)return btoa(bintostr(this.arc4.crypt(this.arc4.create(this.sha1.hmacsha1hex(n,e)),strtobin(t))))}}catch(t){console.log(`crypto.encrypt: failed with ${t}\n`)}return null}authenticate(t,e){try{const n=(e||this.witness||{}).key;if(n)return bintohex(this.sha1.hmacsha1hex(n,t))}catch(t){console.log(`crypto.authenticate: failed with ${t}\n`)}return null}sha1str(t){const e=function(t,e,n,r){return t<20?e&n|~e&r:t>=40&&t<60?e&n|e&r|n&r:e^n^r},n=function(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514},r=function(t,e){const n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n},o=function(t,e){return t<<e|t>>>32-e},s=8*t.length;let c=[];for(var h=0;h<s;h+=8)c[h>>5]|=(255&t.charCodeAt(h/8))<<24-h%32;c[s>>5]|=128<<24-s%32,c[15+(s+64>>9<<4)]=s;const i=Array(80);let a=1732584193,l=-271733879,u=-1732584194,f=271733878,d=-1009589776;for(h=0;h<c.length;h+=16){const t=a,s=l,y=u,b=f,g=d;for(let t=0;t<80;t++){i[t]=t<16?c[h+t]:o(i[t-3]^i[t-8]^i[t-14]^i[t-16],1);const s=r(r(o(a,5),e(t,l,u,f)),r(r(d,i[t]),n(t)));d=f,f=u,u=o(l,30),l=a,a=s}a=r(a,t),l=r(l,s),u=r(u,y),f=r(f,b),d=r(d,g)}c=[a,l,u,f,d],t="";for(h=0;h<32*c.length;h+=8)t+=String.fromCharCode(c[h>>5]>>>24-h%32&255);return strtobin(t)}}const WotCrypto=new WotCryptoClass;