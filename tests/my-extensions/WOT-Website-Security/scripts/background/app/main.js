var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},_slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var s=[],r=!0,i=!1,n=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done)&&(s.push(a.value),!e||s.length!==e);r=!0);}catch(t){i=!0,n=t}finally{try{!r&&o.return&&o.return()}finally{if(i)throw n}}return s}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _objectWithoutProperties(t,e){var s={};for(var r in t)e.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r]);return s}const NOT_ONBOARDING=4;setTimeout((function(){return"debug is off"}),30031220),function(){function t(){const e=yodules.Initiator;e.class=class e{static hasAllArgsReady(t,e){return!(yodules[e].deps||[]).find(t=>!yodules[t]||!yodules[t].ready)}static initWithArgs(t,e){const s=(yodules[e].deps||[]).map(t=>yodules[t]);try{const e=t.apply(this,s);return void 0!==e&&e instanceof Promise?e:Promise.resolve()}catch(t){return Promise.reject(t)}}getNotInitedModules(){return Object.keys(yodules).filter(e=>"function"==typeof yodules[e].init&&!yodules[e].ready&&yodules[e].init!==t)}async initAvailable(){const t=this.getNotInitedModules();for(let s=0;s<t.length;s++){const r=t[s],i=yodules[r];if(!i.initInProgress&&e.hasAllArgsReady(i.init,r)){i.initInProgress=!0;try{await e.initWithArgs(i.init,r);i.ready=!0,delete i.initInProgress}catch(t){i.initInProgress=!1,i.error=t,i.ready=!1}}}this.getNotInitedModules().length<t.length&&await this.initAvailable()}async check(t){return this.getNotInitedModules().length?await this.initAvailable():t>2e3,t<1e5&&setTimeout(()=>this.check(2*t),2*t),this}},e.instance=new e.class,e.instance.check(1)}self.yodules=self.yodules||{},yodules.Initiator={init:t},t()}();class MainApp{constructor(t,e){this.store=t,this.alarmsManager=new AlarmsManager(t),e&&this.alarmsManager.clearAlarms(),this.myElement=new MyClass(t),this.setExperimentalData(),this.fireInstallEvent(),this.setFirstRunDate(),this.retention=new RetentionEvent(t),this.piFilter=new PiFilter,this.getAllTabs=_.throttle(this.getAllTabs.bind(this),1500),this.consecutiveCacheMisses=0,this.lastHostLookedupInCache=null,this.contentStateHandler=new ContentStateHandler(this.store),this.contentStateHandler.handleNextPopupState(),this.trackerBlocker=new TrackerBlocker(this.store),this.fontsStyleSheet=null,this.unsubscribeCache=this.store.subscribe(()=>{const t=this.store.getState();var e=t.trackerBlockerData;const s=e.reload;return(e.reloadAllowList||s)&&(s?this.trackerBlocker.flush():this.trackerBlocker.flushAllowList(),this.store.dispatch({type:RELOAD_TRACKERS_DATA_OFF})),webextApi.storage.local.set({[STORAGE_TOKEN]:t})});const s=this.store.getState().api,r=this.store.getState().rtApi;this.store.getState().user.isPremiumUser&&this.store.dispatch({type:GET_USER_PLAN}),this.alarmsManager.doOnBackgroundStart(),WotApi.registerAll(s,r).then(t=>{var e=_slicedToArray(t,2);const s=e[0],r=e[1];this.store.dispatch(saveWitness(s)),this.store.dispatch(saveRtWitness(r)),this.store.dispatch(clearTemplist()),this.store.dispatch(clearComments()),this.requestSerpConfig(),this.store.dispatch(clearRating()),this.store.dispatch(loadTrackersList()),this.store.dispatch(deleteTrackersHistory()),this.getAllTabs()}),webextApi.tabs.onUpdated.addListener(this.tabUpdateListener.bind(this)),webextApi.tabs.onActivated.addListener(this.tabListener.bind(this)),webextApi.windows.onFocusChanged.addListener(this.windowListener.bind(this)),webextApi.runtime.onMessage.addListener((t,e,s)=>{switch(t.name){case OPEN_TAB_MESSAGE:void 0!==t.url&&webextApi.tabs.create({url:t.url});break;case OPEN_IN_CURR_TAB_MESSAGE:void 0!==t.url&&webextApi.tabs.update({url:t.url});break;case CLOSE_TAB_MESSAGE:webextApi.tabs.remove(e.tab.id);break;case CONSOLE_LOG_MESSAGE:console.log(t);break;case CONTENT_DISCONNECTED:this.contentStateHandler.setErrorState(e.tab.id);break;case CONTENT_CONNECTED:this.contentStateHandler.handleNextPopupState();break;case SEND_MESSAGE:this.handleSendMessage(t.params);break;case RETRY_QUERY_DATA:this.contentStateHandler.retryQueryData();break;case TURN_ON_PROTECTION:this.alarmsManager.toggleOptOutAlarm(!1),webextApi.action.setBadgeText({text:""}),this.contentStateHandler.handleNextPopupState();break;case TURN_OFF_PROTECTION:this.alarmsManager.toggleOptOutAlarm(!0),this.contentStateHandler.handleNextPopupState();break;case CHECK_NEXT_POPUP_STATE:this.contentStateHandler.handleNextPopupState(!0);break;case OPEN_POPUP:webextApi.action.setBadgeText({text:""});break;case ICON_NOTIFICATION:webextApi.action.setBadgeText({text:"1"});break;case POP_BLOCKED:break;case TOGGLE_WOT_SLIDER_REQUEST:this.contentStateHandler.toggleSlider(t.message);break;case SYSTEM_PAGE:getCurrentTab().then(e=>{this.myElement&&"function"==typeof this.myElement.fire&&this.myElement.fire({[GA_CATEGORY_KEY]:"System Page",[GA_ACTION_KEY]:t.isError?"Error_Opened":"Opened",[GA_LABEL_KEY]:e.url||"N/A"})});break;case INJECT_FONTS:this.fontsStyleSheet||this.getFonts(),s({fonts:this.fontsStyleSheet});break;case LEAK_MONITORING_ON:this.startLeakMonitoringInterval(!0);break;case LEAK_MONITORING_OFF:this.alarmsManager.toggleGetLeakDataAlarm(!1);break;case RESTART_SCANTIME_ALARM:this.alarmsManager.createUpdatePopupScanTimeAlarm()}});const i=this.store.getState().survey;i.installDate||this.store.dispatch(updateSurveyState(_extends({},i,{installDate:(new Date).getTime()})));var n=this.store.getState().settings;const a=n.protection,o=n.leakMonitoring;a?this.store.dispatch(turnOnProtection()):(this.store.dispatch(turnOffProtection()),this.startOptoutInterval()),this.changeShieldLevels(),this.getFonts(),this.store.dispatch(updatePopupScanTime(new Date)),o&&this.startLeakMonitoringInterval(!1),webextApi.runtime.setUninstallURL(UNINSTALL_URL,()=>{webextApi.runtime.lastError}),1===compareVersions(VERSION,i.prevVersion)&&(this.store.dispatch(updateSurveyState({installDate:(new Date).getTime(),prevVersion:VERSION,isShowed:!1})),this.store.getState().common.tid!==GA_ACCOUNT&&this.store.dispatch(updateGaID(GA_ACCOUNT))),webextApi.action.setBadgeBackgroundColor({color:"#c53929"});const l=webextApi.i18n.getMessage("checkUrl");webextApi.contextMenus.removeAll((function(){webextApi.contextMenus.create({id:"WotContextMenu",title:l,contexts:["link"]})})),webextApi.contextMenus.onClicked.addListener(this.preCheckLink.bind(this)),webextApi.webNavigation.onHistoryStateUpdated.addListener(()=>{getCurrentTab().then(t=>{(t.id||0===t.id)&&webextApi.tabs.sendMessage(t.id,{action:HISTORY_UPDATED},()=>{webextApi.runtime.lastError})})})}onQueryDataEvent(t){try{t&&t.detail instanceof Array&&t.detail.length>2&&this.contentStateHandler.fetchRating(t.detail[2],t.detail[1])}catch(t){}}requestSerpConfig(){this.store.dispatch(requestSerpsConf()),this.alarmsManager.createSerpRequestAlarm()}handleSendMessage(t){const e=t.sendInternalAnalytics,s=_objectWithoutProperties(t,["sendInternalAnalytics"]);this.myElement.fire&&this.myElement.fire(s),e&&this.sendInternalAnalyticsEvent(s)}openPreCheck(t){webextApi.tabs.query({active:!0,currentWindow:!0},e=>{e&&e[0]&&webextApi.tabs.sendMessage(e[0].id,{action:PRE_CHECK,url:t},()=>{webextApi.runtime.lastError})})}preCheckLink(t){if("WotContextMenu"!==t.menuItemId)return;const e=this.store.getState().user;if(!e||!e.isPremiumUser)return this.openPreCheck();WotApi.query({links:[t.linkUrl]}).then(e=>{this.store.dispatch(saveRating(e)),setTimeout(()=>{this.openPreCheck(getCleanDomain(t.linkUrl))})},t=>{this.myElement&&"function"==typeof this.myElement.fire&&this.myElement.fire({[GA_CATEGORY_KEY]:"pre_check",[GA_ACTION_KEY]:"Error",[GA_LABEL_KEY]:t})})}startOptoutInterval(){this.alarmsManager.toggleOptOutAlarm(!0)}startLeakMonitoringInterval(t){this.store.dispatch(getLeakData(t)),this.alarmsManager.toggleGetLeakDataAlarm(!0)}tabListener(){this.getAllTabs(!0)}tabUpdateListener(t,e,s){"loading"!==e.status&&"complete"!==e.status||this.getAllTabs()}windowListener(t){-1!==t&&this.getAllTabs(!0)}websiteExternalMessageListener(t,e,s){const r=["mywot.com"],i=e.url,n=getDomain(i);for(const t of r)t===n&&s({isActive:!0})}sendInternalAnalyticsEvent(t){const e=this.store.getState().remoteConfig.features.internalEvents;e&&e.enable&&WotApi.sendInternalAnalytics(t)}fireInstallEvent(){const t=this.store.getState().installEventFired,e=getOS();if(t)return this.store.dispatch(saveInstall()),void 0;_.delay(()=>{-1!==e.indexOf("Android")||-1!==e.indexOf("iOS")?(this.store.dispatch(turnOffParentalControlExtraIcon()),webextApi.tabs.create({url:WELCOME_URL})):(this.store.dispatch(turnOffProtection()),this.openPresettingsPage())},1500),_.delay(()=>{this.myElement.fire&&this.myElement.fire({[GA_CATEGORY_KEY]:"General",[GA_ACTION_KEY]:"WOT_installed"})},3e3),this.store.dispatch(saveInstall())}setFirstRunDate(){if(this.store.getState().firstRunDate)return 0===this.store.getState().onboarding.step&&+new Date-this.store.getState().firstRunDate>=864e5&&this.store.dispatch(toNextStepOnboarding(4)),void 0;const t=Date.now();this.store.dispatch(saveFirstRunDate(t))}setExperimentalData(){if("chrome"===browserName&&!this.store.getState().firstRunDate){const t=_.merge({},{status:getRandomBool(),lastVersion:VERSION});this.store.dispatch(saveExperimentalData(t)),this.includeExperimentalFeatures(t)}}includeExperimentalFeatures(t){}changeShieldLevels(){const t=this.store.getState().serps.length;for(let e=0;e<t;e++)this.store.dispatch(setShieldsLevel(SHIELDS_LEVEL_HIGH,e))}getAllTabs(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];webextApi.windows.getCurrent({},e=>{webextApi.runtime.lastError||(e&&e.focused||"edge"===crossbrowserName||-1!==navigator.userAgent.indexOf("Mac"))&&webextApi.tabs.query({},s=>{s&&(this.store.dispatch(saveTabs(s,e)),this.updateIcon(s,e,t))})})}setIcon(t){webextApi.action.setIcon(t),this.consecutiveCacheMisses=0}updateIconNotification(t,e){const s=t.user,r=t.leakMonitoring,i=t.settings;let n="",a="#c53929";["yellow","red"].includes(e)&&(n="!",a="#FFD900");const o=i.leakMonitoring&&r&&r.breaches.filter(t=>!t.isDismissed),l=!(!o||!o.length);s&&s.isPremiumUser&&l&&(n=""+o.length,a="#165ADA"),webextApi.action.setBadgeText({text:n}),webextApi.action.setBadgeBackgroundColor({color:a})}updateIcon(t,e,s){if(this.store.getState().settings.protection){for(const r of t)if(r.active&&r.windowId===e.id){const t=this.store.getState(),e=t.ratings,i=t.user,n=t.reviews,a=getEncodedDomain(r.url);if(a!==this.lastHostLookedupInCache&&(this.consecutiveCacheMisses=0,this.lastHostLookedupInCache=a),!SUPPORTED_PROTOCOLS.test(r.url)||checkLocalhost(r.url))this.setIcon({path:ICONS.gray,tabId:r.id});else if("object"==typeof e[a]){const s=e[a],o=i.uid||1,l=n[o]&&n[o][a],c=getShieldColor(s,l).color;this.setIcon({path:ICONS[c],tabId:r.id}),this.updateIconNotification(t,c)}else!e[a]&&this.consecutiveCacheMisses++<MAX_CONSECUTIVE_CACHE_MISSES&&(s&&this.contentStateHandler.retryQueryData(),setTimeout(this.getAllTabs.bind(this),800));return}}else this.setIcon({path:ICONS.gray})}turnOnProtection(){this.store.dispatch(turnOnProtection())}turnOffProtection(){this.store.dispatch(turnOffProtection())}getFilteredState(t,e){return Object.keys(t).filter(t=>!e.includes(t)).reduce((e,s)=>(e[s]=t[s],e),{})}getFonts(){WotNetwork.get(FONTS_URL).then(t=>{this.fontsStyleSheet=t.responseText}).catch(t=>{})}openPresettingsPage(){"firefox"===crossbrowserName?webextApi.tabs.create({url:""+EXT_OPTIN_URL}):webextApi.tabs.create({url:""+(MYWOT_OPTIN_ROOT+EXT_OPTIN_URL)})}}self.yodules=self.yodules||{},void(yodules.Serp={init:function(t,e){const s=yodules.Serp,r=t.instance,i=e.instance;s.class=class{bind(){r.onBeforePack((t,e)=>{const s=e.chromeTab&&e.chromeTab.url;if(s)return this.validatePage(s,t).then(t=>{t&&i.unshiftItem({type:"serp",data:t})})})}validatePage(t,e){return t.match(/^https:\/\/www\.google(?:\.\w+)+\/search\?/g)&&-1===t.indexOf("&tbm=")?new Promise((t,s)=>{const r=function(e){chrome.runtime.lastError&&(this.error=chrome.runtime.lastError),e=!!e&&e[0],t(e.result)};try{const t={target:{tabId:e}},s=this.scriptInjectionConstructorV3(),i=Object.assign({},t,s);chrome.scripting.executeScript(i,r)}catch(t){}}):Promise.resolve()}scriptInjectionConstructorV3(){return{args:["#tads div[data-text-ad]","#tadsb div[data-text-ad]","#res .g:not(#imagebox_bigimages)","cite, .x2VHCd.OSrXXb.qzEoUe, a div + div span + span","a","href",".MUxGbd.yDYNvb.lyLwlc","[role='heading']","h3","span"],func:(t,e,s,r,i,n,a,o,l,c)=>{const h=[],d=[];let u=0;function p(t,e){let s,l,c,h,d,u;u=t.querySelector(i),d=u.querySelector(o),s=d.innerText,l=u.getAttribute(n),c=t.querySelector(r),c=c?c.innerText:null;const p=t.querySelector(a);h=p?p.innerText:"";const g={title:s,href:l,description:h,index:e};return c&&(g.cite=c),g}function g(t){const e={url:t.href,label:t.title,position:t.index,description:t.description};return t.cite&&(e.green_link=t.cite),e}if(document.querySelectorAll(t).forEach(t=>{h.push(p(t,u++))}),document.querySelectorAll(s).forEach(t=>{const e=function(t,e){let s,n,a,o,h,d;a=t.querySelector(i),n=a.querySelector(l)?a.querySelector(l).innerText:a.innerText,s=a.href,o=t.querySelector(r),o=o?o.innerText:null,h=Array.from(t.querySelectorAll(c)).reduce((t,e)=>e.innerText.length>t.length?e.innerText:t,""),d=h||"";const u={title:n,href:s,description:d,index:e};return o&&(u.cite=o),u}(t,u+1);e&&e.title&&e.href&&(d.push(e),u++)}),document.querySelectorAll(e).forEach(t=>{h.push(p(t,u++))}),d.length||h.length)return{org:d.map(g),ads:h.map(g),url:document.baseURI,timestamp:Date.now()}}}}},s.instance=new s.class,s.instance.bind()},deps:["SendRequestForTab","Ployder"]});