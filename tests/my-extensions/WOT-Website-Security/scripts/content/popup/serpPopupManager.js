const mobileWidth=450;class SerpPopupManager{constructor(e,t,o){this.store=e,this.serpid=o,this.isOnboarding=t,this.onBoardingStep=e.getState().onboarding.step,this.info={},this.isInitOnboardingCalled=!1,this.immediateClearPopup=this.immediateClearPopup.bind(this),this.clearPopup=this.clearPopup.bind(this),this.onLogoClick=this.onLogoClick.bind(this),window.addEventListener("scroll",()=>{0!==this.onBoardingStep&&this.immediateClearPopup()}),window.addEventListener("onclick",e=>{if(!e.target.classList.contains("wot_shield")){document.querySelector("."+POPUP_OVERLAY).classList.contains("wot-open")&&this.immediateClearPopup()}}),window.addEventListener("message",e=>{if(e.data&&e.data.type===SHIELD_HOVER_EVENT){var t=e.data;const o=t.id,i=t.host,s=t.color;o&&this.onShieldOver(o,i,s)}e.data&&e.data.type===SHIELDS_READY&&!this.isInitOnboardingCalled&&(this.isInitOnboardingCalled=!0,this.initOnboarding())})}onShieldOver(e,t,o){0===this.onBoardingStep&&(this.store.dispatch(toNextStepOnboarding()),this.onBoardingStep+=1),GA("Search Popup","Shown "+o,t);const i=this.getPopupPositioning(e);this.showPopup(t,i,o)}preparePopupData(e,t){const o=this.store.getState();var i=o.ratings[e]||{};const s=i.rating,n=i.confidence,a=i.safety,r=i.commentsCount;this.info={host:e,shieldColor:t,bubbleColor:o.ratings[e].color,categories:o.ratings[e].categories||[],safety:a,childSafety:o.ratings[e].childSafety,commentsCount:r,rating:s,confidence:n,onboarding:o.onboarding,settings:o.settings},void 0===r&&this.store.dispatch(getCommentsCount(e))}desktopPopup(e){let t=e.info,o=e.isOnboarding,i=e.positionInfo;const s=setInterval(()=>{const e=document.getElementById("wot-popup-body");e&&(e.style.opacity=1,clearInterval(s))},50),n=i.styles,a=i.isBottomOfPage;return React.createElement("div",{style:n,onMouseLeave:this.clearPopup},React.createElement("div",{className:"shield__popover_container"},o&&t.onboarding.step<SERP_ONBOARDING_STEPS_COUNT&&React.createElement(ShieldOnBoarding,{closePopup:this.immediateClearPopup,safety:t.safety,step:this.onBoardingStep,childSafety:t.childSafety,color:this.info.shieldColor,onboarding:t.onboarding,dispatch:this.store.dispatch}),this.popupBody(t,a)))}mobilePopup(e){let t=e.info;return document.querySelector("."+POPUP_OVERLAY).classList.add("wot-open"),React.createElement("div",{className:"shield__popover_container",onMouseLeave:this.clearPopup},React.createElement("div",{className:"wot-mobile_popup"},this.popupBody(t,!0)))}getPopupHeaderText(e){switch(e){case SAFE:return"trustedSite";case SUSPICIOUS:return"suspiciousSite";case NOT_SAFE:return"untrustedSite";case UNKNOWN:default:return"unknownSite"}}getHeaderClass(e,t){let o;switch(e){case SAFE:o="safe";break;case SUSPICIOUS:o="suspicious";break;case NOT_SAFE:o="unsafe";break;case UNKNOWN:default:o="unknown"}return`shield__header_${o} ${t?"":"wot_popup_top_of_screen"}`}popupBody(e,t){const o=e.safety,i=e.childSafety,s=e.shieldColor;return React.createElement("div",{id:"wot-popup-body",className:"shield__popover"+(i===NOT_SAFE?" adult":"")},React.createElement("div",{className:"shield__header "+this.getHeaderClass(o,t)},React.createElement("div",{className:`shield_${s}__empty header_shield`}),React.createElement("div",{className:"header_text"},translate(this.getPopupHeaderText(o))),React.createElement(SvgIcon,{className:"shield__logo",svg:"logo-bw.svg",onClick:this.onLogoClick})),i===NOT_SAFE&&React.createElement("div",{className:"child-label"},React.createElement(SvgIcon,{className:"child-label_icon",svg:"18+_filled.svg"}),React.createElement("div",null,translate("popupAdultStrip"))),React.createElement(ScorecardData,{info:e}),React.createElement("div",{className:"shield__body_separator"}),React.createElement(SerpPopupFooter,{info:e,inBottomOfPage:t}))}showPopup(e,t,o){this.preparePopupData(e,o);const i=this.isMobileView()?this.mobilePopup({info:this.info}):this.desktopPopup({info:this.info,isOnboarding:this.isOnboarding,positionInfo:t});ReactDOM.render(React.createElement(ReactRedux.Provider,{store:this.store},React.createElement("div",null,i)),document.querySelector("."+POPUP_CONTAINER))}showFirstTooltip(e,t){ReactDOM.render(React.createElement(ReactRedux.Provider,{store:this.store},React.createElement("div",{style:e},React.createElement(ShieldOnBoarding,{closePopup:this.immediateClearPopup,shieldColor:this.info.shieldColor,safety:this.info.safety,color:this.info.shieldColor,step:this.onBoardingStep,onboarding:this.info.onboarding,dispatch:this.store.dispatch,isFlipped:t}))),document.querySelector("."+POPUP_CONTAINER))}isMobileView(){return window.innerWidth<=450||window.innerHeight<=450}fixRightOverflow(e){const t=document.body.offsetWidth;return e+320>t&&(e=t-320),e}getPopupPositioning(e){if(this.isMobileView())return;var t=this.getPosition(document.getElementById(e));const o=t.left,i=t.top,s=t.bottom,n={},a=document.documentElement.clientHeight;let r,l;return n.position="fixed",this.isOnboarding?(r=i+270>a+window.scrollY,l=36,r?(n.bottom=a-(i-window.scrollY)-l+"px",n.left=o+"px"):(n.position="absolute",n.left=o-4+"px")):(r=i+270>a,l=18,r&&(n.bottom=a-s-l+"px"),n.left=this.fixRightOverflow(o)+"px"),n.top=r?"auto":i+"px",n.zIndex="2147483646",{styles:n,isBottomOfPage:r}}clearPopup(){this.isOnboarding&&this.onBoardingStep<SERP_ONBOARDING_STEPS_COUNT||this.immediateClearPopup()}immediateClearPopup(){document.querySelector("."+POPUP_OVERLAY).classList.remove("wot-open");const e=document.querySelector("."+POPUP_CONTAINER);e.innerHTML&&(e.innerHTML="",window.postMessage({type:SHIELD_HOVER_EVENT,id:""},window.location.origin),this.store.dispatch(incrementPopUpCounter()))}onLogoClick(){GA("Search Popup","WOT Logo "+this.info.shieldColor,this.info.host),webextApi.runtime.sendMessage({name:OPEN_TAB_MESSAGE,url:`${MAIN_PAGE_URL}?${WOT_PRODUCT}=addon`})}initOnboarding(){if(this.isMobileView()||!this.isOnboarding||0!==this.onBoardingStep)return;let e;const t=Array.from(document.querySelectorAll(".wot_shield:not(.shield_gray)")).find(t=>(e=this.getPosition(t),e.top>14));if(!e||!t)return;const o={position:"absolute",left:e.left+23+"px",zIndex:"2147483646"},i=e.top-130<0;o.top=(i?e.top+164:e.top-14)+"px",this.showFirstTooltip(o,i)}getPosition(e){"string"==typeof e&&(e=document.querySelector(e));const t=e.getBoundingClientRect();let o=t.top,i=t.left;const s=t.bottom;if(this.isOnboarding&&this.onBoardingStep<SERP_ONBOARDING_STEPS_COUNT){const e=document.body.getBoundingClientRect();o-=e.top,i-=e.left}return{top:o,left:i,bottom:s}}}